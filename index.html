<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦–å¸­åˆ†æå¸«çµ‚æ¥µæˆ°æƒ…å®¤</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #1a1a1a; color: #fff; padding: 20px; }
        .dashboard { max-width: 600px; margin: 0 auto; background: #2d2d2d; border-radius: 10px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h2 { border-bottom: 2px solid #d4af37; padding-bottom: 10px; color: #d4af37; } /* é‡‘è‰²æ¨™é¡Œ */
        .price-display { font-size: 3em; font-weight: bold; margin: 20px 0; text-align: center; }
        .status-bar { display: flex; justify-content: space-between; font-size: 0.9em; color: #aaa; background: #333; padding: 10px; border-radius: 5px; }
        .source-tag { padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .up { color: #ff4d4d; } /* å°è‚¡æ¼²æ˜¯ç´… */
        .down { color: #00e676; } /* å°è‚¡è·Œæ˜¯ç¶  */
        .btn { width: 100%; padding: 10px; background: #d4af37; border: none; font-size: 1.2em; cursor: pointer; color: #000; font-weight: bold; border-radius: 5px; margin-top: 10px; }
        .btn:hover { background: #e5c14b; }
        
        /* ç‹€æ…‹ç‡ˆè™Ÿé¡è‰² */
        .mode-primary { color: #00d2ff; border: 1px solid #00d2ff; } /* é‰…äº¨è— */
        .mode-backup { color: #ffbf00; border: 1px solid #ffbf00; }  /* è­‰äº¤æ‰€é»ƒ */
        .mode-safe { color: #ff4d4d; border: 1px solid #ff4d4d; }    /* Yahooç´… */
    </style>
</head>
<body>

<div class="dashboard">
    <h2>ğŸ“Š å°è‚¡å¤§ç›¤å³æ™‚ç›£æ§ (é˜²æ–·ç·šç‰ˆ)</h2>
    
    <div class="price-display" id="priceDisplay">è®€å–ä¸­...</div>
    
    <div class="status-bar">
        <span id="sourceLabel">ç³»çµ±å¾…å‘½</span>
        <span id="timeLabel">--:--:--</span>
    </div>

    <button class="btn" onclick="runUltimateStrategy()">ğŸ”„ ç«‹å³æ›´æ–°å ±åƒ¹</button>
    <div style="margin-top:10px; font-size:0.8em; color:#666; text-align:center;">
        ç­–ç•¥é †åº: Anue (3s) âœ TWSE (3s) âœ Yahoo
    </div>
</div>

<script>
    // ----------------------------------------------------
    //  é¦–å¸­åˆ†æå¸«æ ¸å¿ƒé‚è¼¯å€
    // ----------------------------------------------------

    // è¼”åŠ©å‡½å¼ï¼šå¸¶æœ‰ Timeout çš„ Fetch
    async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 3000 } = options; // é è¨­ 3 ç§’
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        
        try {
            const response = await fetch(resource, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(id);
            return response;
        } catch (error) {
            clearTimeout(id);
            throw error;
        }
    }

    // æ ¸å¿ƒåŸ·è¡Œå‡½å¼
    async function runUltimateStrategy() {
        const display = document.getElementById('priceDisplay');
        const sourceLabel = document.getElementById('sourceLabel');
        const timeLabel = document.getElementById('timeLabel');
        
        display.innerText = "é€£ç·šä¸­...";
        display.style.color = "#fff";
        
        // --- 1. Primary: é‰…äº¨ç¶² Anue ---
        try {
            console.log("å˜—è©¦é€£ç·š Primary (Anue)...");
            sourceLabel.innerText = "é€£ç·š Primary (Anue)...";
            
            // é‰…äº¨ç¶² API (æ³¨æ„ï¼šè‹¥åœ¨æœ¬åœ°åŸ·è¡Œé‡åˆ° CORS éŒ¯èª¤ï¼Œéœ€å®‰è£ Allow CORS å¥—ä»¶)
            const res = await fetchWithTimeout("https://ws.api.cnyes.com/ws/api/v1/quote/quotes/TSE:T00", { timeout: 3000 });
            if (!res.ok) throw new Error("Status error");
            
            const data = await res.json();
            const quote = data.data[0];
            // æŠ“æˆäº¤åƒ¹ï¼Œè‹¥ç„¡å‰‡æŠ“æ”¶ç›¤åƒ¹
            let price = quote.price || quote.close;
            
            updateUI(price, "Anue (é‰…äº¨ç¶²)", "mode-primary", quote.change_rate);
            return; // æˆåŠŸå°±çµæŸï¼Œä¸å¾€ä¸‹è·‘

        } catch (e) {
            console.warn("Anue é€£ç·šå¤±æ•—æˆ–è¶…æ™‚:", e);
        }

        // --- 2. Backup: è­‰äº¤æ‰€ TWSE ---
        try {
            console.log("åˆ‡æ›è‡³ Backup (TWSE)...");
            sourceLabel.innerText = "åˆ‡æ› Backup (TWSE)...";

            // è­‰äº¤æ‰€ API
            // ç‚ºäº†é¿é–‹ CORSï¼Œå¯¦å‹™ä¸Šå‰ç«¯å¸¸éœ€é€é 'cors-anywhere' æˆ–é¡ä¼¼ä»£ç†ï¼Œ
            // ä½†æ­¤è™•æ¼”ç¤ºæ¨™æº–è·¯å¾‘ã€‚
            const timestamp = new Date().getTime();
            const res = await fetchWithTimeout(`https://mis.twse.com.tw/stock/api/getStockInfo.jsp?ex_ch=tse_t00.tw&json=1&delay=0&_=${timestamp}`, { timeout: 3000 });
            if (!res.ok) throw new Error("Status error");

            const data = await res.json();
            const info = data.msgArray[0];
            let price = info.z; // z æ˜¯æœ€è¿‘æˆäº¤åƒ¹
            
            if (price && price !== "-") {
                updateUI(price, "TWSE (è­‰äº¤æ‰€)", "mode-backup", 0); // è­‰äº¤æ‰€ API ä¸å®¹æ˜“ç›´æ¥ç®—æ¼²è·Œå¹…ï¼Œé€™è£¡å…ˆç°¡åŒ–
                return;
            } else {
                throw new Error("TWSE æ•¸æ“šç„¡æ•ˆ");
            }

        } catch (e) {
            console.warn("TWSE é€£ç·šå¤±æ•—æˆ–è¶…æ™‚:", e);
        }

        // --- 3. Safe Mode: Yahoo (é€éæ¨¡æ“¬æˆ–å¾Œå‚™) ---
        // ç´”å‰ç«¯ JS å¾ˆé›£ç›´æ¥æŠ“ Yahoo (CORS æœ€åš´æ ¼)ï¼Œé€™è£¡ä½œç‚ºç¤ºæ„
        // å¦‚æœå‰å…©è€…éƒ½æ›äº†ï¼Œé¡¯ç¤ºéŒ¯èª¤æˆ–è·³è½‰
        console.log("åˆ‡æ›è‡³ Safe Mode...");
        display.innerText = "ç³»çµ±ç¹å¿™";
        display.style.color = "#888";
        sourceLabel.innerHTML = "<span class='mode-safe source-tag'>å…¨éƒ¨é€£ç·šé€¾æ™‚</span>";
        alert("é‰…äº¨ç¶²èˆ‡è­‰äº¤æ‰€çš†ç„¡å›æ‡‰ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹ (æˆ– CORS è¨­å®š)");
    }

    // æ›´æ–°ä»‹é¢ UI
    function updateUI(price, sourceName, cssClass, changeRate) {
        const display = document.getElementById('priceDisplay');
        const sourceLabel = document.getElementById('sourceLabel');
        const timeLabel = document.getElementById('timeLabel');

        // æ ¼å¼åŒ–åƒ¹æ ¼
        display.innerText = parseFloat(price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        // ç°¡å–®åˆ¤æ–·æ¼²è·Œé¡è‰² (è‹¥æœ‰æ¼²è·Œå¹…æ•¸æ“š)
        if (changeRate) {
            display.style.color = parseFloat(changeRate) >= 0 ? "#ff4d4d" : "#00e676";
        } else {
            display.style.color = "#fff";
        }

        // æ›´æ–°ä¾†æºæ¨™ç±¤
        sourceLabel.innerHTML = `<span class="source-tag ${cssClass}">${sourceName}</span>`;
        
        // æ›´æ–°æ™‚é–“
        const now = new Date();
        timeLabel.innerText = now.toLocaleTimeString();
    }

    // é é¢è¼‰å…¥å¾Œè‡ªå‹•åŸ·è¡Œä¸€æ¬¡
    runUltimateStrategy();

</script>

</body>
</html>
